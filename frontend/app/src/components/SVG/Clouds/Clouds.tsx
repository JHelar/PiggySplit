import {
	Canvas,
	Group,
	LinearGradient,
	Path,
	Rect,
	type Transforms3d,
	vec,
} from "@shopify/react-native-skia";
import { useEffect, useRef } from "react";
import {
	convertToRGBA,
	Easing,
	makeMutable,
	useAnimatedReaction,
	useSharedValue,
	withRepeat,
	withTiming,
} from "react-native-reanimated";
import {
	StyleSheet,
	UnistylesRuntime,
	useUnistyles,
} from "react-native-unistyles";
import { curve } from "../utils/curve";
import type { CloudsProps } from "./Clouds.types";

const CLOUDS_BACK = [
	[
		"M102.652 240C111.94 240 119.551 246.714 120.241 255.236C121.795 254.362 123.618 253.859 125.566 253.859C130.321 253.859 134.32 256.855 135.505 260.926C137.636 262.169 139.001 264.075 139.001 266.214C139.001 269.961 134.813 272.999 129.646 272.999C128.984 272.999 128.338 272.948 127.715 272.854L127.34 272.854C126.764 272.947 126.171 272.999 125.566 272.999C124.979 272.999 124.404 272.95 123.844 272.862L87.2607 272.952C86.8486 272.982 86.4311 272.999 86.0088 272.999C85.6212 272.999 85.2374 272.983 84.8584 272.958L78.1377 272.975C77.9294 272.989 77.7187 272.999 77.5059 272.999C77.3086 272.999 77.1133 272.99 76.9199 272.978L76.8926 272.979C76.8927 272.978 76.8929 272.978 76.8936 272.977C73.0349 272.713 70 269.988 70 266.663C70 266.337 70.0296 266.016 70.0859 265.703C70.0302 265.416 70 265.119 70 264.815C70 262.666 71.4619 260.87 73.4131 260.431C74.8963 256.41 79.6476 253.422 85.3623 253.212C86.9917 245.675 94.1135 240 102.652 240Z",
		"M102.652 246.409C111.777 246.409 119.284 251.631 120.198 258.326C121.325 257.846 122.586 257.578 123.918 257.578C127.147 257.578 129.962 259.157 131.447 261.495C135.752 262.016 139.001 264.368 139.001 267.193C139.001 270.4 134.813 272.999 129.646 273C128.999 273 128.366 272.958 127.756 272.88L125.388 272.885C124.91 272.958 124.419 272.999 123.918 272.999C123.43 272.999 122.951 272.96 122.484 272.891L88.4277 272.958C88.0226 272.985 87.6115 273 87.1953 273C86.8079 273 86.4248 272.987 86.0469 272.963L78.1191 272.979C77.9169 272.991 77.7123 273 77.5059 273C77.3143 273 77.1245 272.991 76.9365 272.981L76.8926 272.982C76.8926 272.982 76.8925 272.98 76.8936 272.979C73.035 272.754 70.0002 270.423 70 267.578C70 267.298 70.0295 267.023 70.0859 266.755C70.0303 266.51 70 266.256 70 265.996C70.0002 263.875 71.9435 262.156 74.3398 262.156C74.7873 262.156 75.2189 262.215 75.625 262.327C75.8716 262.281 76.1232 262.244 76.3789 262.216C77.9858 259.964 81.2532 258.301 85.1787 257.872C86.3629 251.396 93.7346 246.409 102.652 246.409Z",
	],
	[
		"M322.48 217C330.023 217 336.205 223.714 336.766 232.236C338.027 231.362 339.507 230.859 341.09 230.859C344.952 230.859 348.2 233.855 349.162 237.926C350.892 239.169 352.001 241.076 352.001 243.214C352.001 246.961 348.599 249.999 344.403 249.999C343.865 249.999 343.341 249.948 342.835 249.854L342.53 249.854C342.062 249.947 341.581 249.999 341.09 249.999C340.613 249.999 340.146 249.95 339.69 249.862L309.981 249.952C309.646 249.982 309.307 249.999 308.964 249.999C308.649 249.999 308.337 249.983 308.029 249.958L302.571 249.975C302.402 249.989 302.231 249.999 302.058 249.999C301.898 249.999 301.74 249.99 301.583 249.978L301.56 249.979V249.977C298.427 249.713 295.963 246.988 295.963 243.663C295.963 243.336 295.986 243.015 296.032 242.702C295.987 242.415 295.963 242.119 295.963 241.815C295.963 239.665 297.151 237.867 298.737 237.43C299.942 233.41 303.798 230.423 308.438 230.212C309.762 222.675 315.546 217 322.48 217Z",
		"M322.48 223.409C330.393 223.409 336.807 229.361 336.807 236.704C336.807 237.077 336.906 237.542 337.077 238.075C338.093 237.216 339.364 236.705 340.744 236.705C342.287 236.705 343.693 237.343 344.76 238.393C348.79 238.535 352.001 241.077 352.001 244.193C352.001 247.4 348.599 250 344.403 250C343.878 249.999 343.365 249.958 342.869 249.88L341.86 249.883C341.499 249.958 341.126 249.999 340.744 249.999C340.372 249.999 340.008 249.959 339.654 249.888L310.929 249.958C310.6 249.985 310.266 250 309.928 250C309.613 250 309.302 249.987 308.995 249.963L302.066 249.98C301.905 249.992 301.742 250 301.577 250C297.945 250 295 247.125 295 243.579C295 240.032 297.945 237.158 301.577 237.158C301.985 237.158 302.383 237.196 302.771 237.265C304.19 236.029 306.116 235.165 308.29 234.872C309.252 228.396 315.238 223.409 322.48 223.409Z",
	],
	[
		"M47.8418 60C52.9687 60 57.4818 63.0512 60.1084 67.6748C61.6378 67.4115 63.2272 67.2725 64.8584 67.2725C76.954 67.2725 86.7598 74.9067 86.7598 84.3242C86.7597 86.3572 86.3012 88.3064 85.4629 90.1143C86.9754 89.1402 88.792 88.5723 90.7461 88.5723C95.3173 88.5723 99.1355 91.6791 100.065 95.8262C100.654 95.7776 101.258 95.751 101.873 95.751C108.018 95.751 113.001 98.2692 113.001 101.375C113.001 104.481 108.018 106.999 101.873 106.999C100.535 106.999 99.2519 106.879 98.0635 106.66V106.999H1.98145V106.972C-3.04345 106.649 -7.00098 103.143 -7.00098 98.8623C-7.00089 94.3687 -2.64036 90.7258 2.73828 90.7256C3.97754 90.7256 5.16266 90.9208 6.25293 91.2734C6.67041 84.947 11.5108 79.9551 17.4238 79.9551C19.4023 79.9551 21.2599 80.5164 22.873 81.4971C23.9464 74.0265 29.2022 68.201 35.751 67.374C38.4002 62.9195 42.8271 60.0002 47.8418 60ZM48.2559 95.751H48.6045C48.5339 95.6902 48.464 95.629 48.3945 95.5674C48.3482 95.6286 48.3029 95.6905 48.2559 95.751ZM81.541 95.3701C81.4006 95.4985 81.2584 95.6259 81.1133 95.751H81.4443C81.4742 95.6231 81.5057 95.496 81.541 95.3701Z",
		"M49.542 65.4807C56.0846 65.4809 61.6272 69.8625 63.5254 75.9163C72.8184 76.805 80.0076 82.8611 80.0078 90.1995C80.0078 90.8978 79.9412 91.5844 79.8154 92.2561C81.9345 91.3085 84.5271 90.7493 87.3281 90.7493C93.5414 90.7493 98.7319 93.4924 99.9912 97.1526C100.603 97.1061 101.232 97.0803 101.873 97.0803C108.018 97.0803 113.001 99.3006 113.001 102.039C113.001 104.778 108.018 106.999 101.873 106.999C100.535 106.999 99.2519 106.892 98.0635 106.699V106.999H1.98145V106.975C-3.04347 106.69 -7.00098 103.598 -7.00098 99.8235C-7.00079 95.861 -2.64029 92.6489 2.73828 92.6487C3.97754 92.6487 5.16266 92.8212 6.25293 93.1321C6.67059 87.5534 11.5109 83.1516 17.4238 83.1516C21.5646 83.1517 25.1782 85.312 27.1172 88.5217C28.7693 85.4027 31.6299 83.157 34.9932 82.5696C34.9038 81.8987 34.8565 81.2138 34.8564 80.5178C34.8564 72.2133 41.4318 65.4807 49.542 65.4807Z",
	],
	[
		"M192.046 0C195.976 7.21009e-05 199.433 2.20782 201.447 5.55176C202.621 5.36098 203.84 5.26074 205.092 5.26074C214.365 5.26076 221.883 10.7832 221.883 17.5957C221.883 19.0667 221.531 20.4771 220.888 21.7852C222.047 21.0803 223.44 20.669 224.938 20.6689C228.443 20.6689 231.37 22.9165 232.083 25.916C232.534 25.8808 232.998 25.8623 233.47 25.8623C238.181 25.8623 242 27.684 242 29.9307C242 32.1775 238.181 33.999 233.47 33.999C232.444 33.999 231.46 33.9132 230.549 33.7549V33.999H156.886V33.9795C153.033 33.7459 150 31.21 150 28.1133C150 24.8625 153.343 22.2275 157.467 22.2275C158.417 22.2276 159.325 22.3679 160.161 22.623C160.481 18.0467 164.191 14.4356 168.725 14.4355C170.242 14.4355 171.667 14.8426 172.904 15.5527C173.727 10.1472 177.755 5.93051 182.777 5.33301C184.809 2.11149 188.202 0 192.046 0ZM192.361 25.8623H192.63C192.575 25.8177 192.521 25.7727 192.467 25.7275C192.431 25.7721 192.398 25.8183 192.361 25.8623ZM217.883 25.5859C217.775 25.6791 217.665 25.7715 217.554 25.8623H217.809C217.832 25.7695 217.856 25.6772 217.883 25.5859Z",
		"M193.349 3.96472C198.366 3.96475 202.614 7.13608 204.068 11.5165C211.193 12.1591 216.706 16.5376 216.706 21.8466C216.706 22.3516 216.655 22.848 216.559 23.3339C218.183 22.6484 220.171 22.244 222.318 22.244C227.081 22.2441 231.058 24.2286 232.024 26.8759C232.494 26.8421 232.977 26.8241 233.47 26.8241C238.181 26.8241 242 28.4307 242 30.412C242 32.3931 238.181 33.9989 233.47 33.9989C232.444 33.9989 231.46 33.9217 230.549 33.7821V33.9989H183.581C183.569 33.999 183.556 33.9999 183.544 33.9999C183.532 33.9999 183.519 33.999 183.507 33.9989H156.886V33.9813C153.033 33.7753 150 31.5392 150 28.8085C150 25.9419 153.343 23.618 157.467 23.618C158.417 23.6181 159.325 23.7427 160.161 23.9677C160.481 19.9322 164.192 16.748 168.725 16.7479C171.899 16.7479 174.67 18.3108 176.156 20.6327C177.423 18.376 179.617 16.7516 182.196 16.327C182.128 15.8416 182.09 15.3463 182.09 14.8427C182.09 8.83511 187.131 3.96472 193.349 3.96472Z",
	],
] satisfies [string, string][];

const CLOUDS_FRONT = [
	[
		"M19.8726 321C34.9487 321 47.3028 332.801 48.4224 347.779C50.9444 346.243 53.9026 345.359 57.0659 345.359C64.7855 345.359 71.2812 350.625 73.2026 357.781C76.6593 359.967 78.8726 363.316 78.8726 367.073C78.8722 373.659 72.0745 378.998 63.689 378.998C62.6125 378.998 61.5624 378.909 60.5493 378.741L59.9761 378.743C59.031 378.91 58.0586 378.998 57.0659 378.998C56.1046 378.998 55.1626 378.915 54.2456 378.758L-5.10693 378.917C-5.77735 378.969 -6.45691 378.998 -7.14404 378.998C-7.78226 378.998 -8.41372 378.973 -9.0376 378.928L-19.9312 378.957C-20.2655 378.982 -20.6034 378.998 -20.9448 378.998C-21.2607 378.998 -21.5735 378.983 -21.8833 378.962L-21.9399 378.963C-21.9399 378.963 -21.9397 378.961 -21.938 378.958C-28.2016 378.496 -33.1272 373.707 -33.1274 367.863C-33.1274 367.29 -33.0812 366.726 -32.9897 366.176C-33.0802 365.671 -33.1274 365.149 -33.1274 364.615C-33.1274 360.837 -30.7555 357.681 -27.5884 356.909C-25.1811 349.843 -17.4685 344.59 -8.19189 344.221C-5.54698 330.973 6.01258 321 19.8726 321Z",
		"M19.8726 332.264C34.684 332.264 46.868 341.441 48.353 353.208C50.1818 352.366 52.2289 351.895 54.3901 351.895C59.6327 351.895 64.2035 354.668 66.6147 358.778C73.6004 359.695 78.8724 363.83 78.8726 368.793C78.8726 374.429 72.0747 378.998 63.689 378.998C62.6385 378.998 61.6129 378.927 60.6226 378.79L56.7974 378.798C56.0152 378.928 55.2109 378.998 54.3901 378.998C53.5912 378.998 52.8079 378.932 52.0454 378.809L-3.21729 378.927C-3.87473 378.974 -4.54195 378.999 -5.21729 378.999C-5.84921 378.999 -6.47397 378.977 -7.09033 378.936L-19.937 378.963C-20.2694 378.984 -20.6054 378.998 -20.9448 378.998C-21.2607 378.998 -21.5735 378.985 -21.8833 378.967L-21.9399 378.968C-21.9397 378.967 -21.9394 378.966 -21.938 378.964C-28.2016 378.568 -33.1272 374.471 -33.1274 369.47C-33.1274 368.979 -33.0811 368.497 -32.9897 368.026C-33.0803 367.594 -33.1274 367.147 -33.1274 366.689C-33.1272 362.962 -29.9742 359.94 -26.0845 359.94C-25.3576 359.94 -24.6563 360.045 -23.9966 360.241C-23.5982 360.161 -23.1919 360.096 -22.7788 360.047C-20.1708 356.087 -14.8628 353.164 -8.48877 352.408C-6.56523 341.028 5.39849 332.264 19.8726 332.264Z",
	],
	[
		"M363.893 83.5C371.455 83.5001 378.11 88.1094 381.984 95.0938C384.241 94.6958 386.586 94.4854 388.992 94.4854C406.833 94.4856 421.296 106.018 421.296 120.244C421.296 123.315 420.621 126.26 419.385 128.99C421.615 127.52 424.294 126.662 427.176 126.662C433.918 126.662 439.552 131.355 440.924 137.62C441.791 137.547 442.681 137.508 443.588 137.508C452.652 137.508 460.001 141.311 460.001 146.003C460.001 150.695 452.652 154.499 443.588 154.499C441.614 154.499 439.722 154.318 437.969 153.987V154.499H296.248V154.462C288.836 153.974 282.999 148.674 282.999 142.207C282.999 135.419 289.431 129.915 297.364 129.915C299.19 129.915 300.937 130.208 302.544 130.739C303.161 121.184 310.304 113.646 319.024 113.646C321.943 113.646 324.684 114.491 327.063 115.973C328.647 104.688 336.399 95.8874 346.059 94.6387C349.966 87.9099 356.496 83.5 363.893 83.5ZM364.501 137.508H365.018C364.913 137.416 364.811 137.323 364.708 137.229C364.639 137.323 364.571 137.416 364.501 137.508ZM413.597 136.933C413.39 137.127 413.18 137.319 412.966 137.508H413.452C413.496 137.314 413.545 137.123 413.597 136.933Z",
		"M366.398 91.7793C376.049 91.7793 384.225 98.3987 387.024 107.544C400.732 108.886 411.337 118.035 411.337 129.121C411.337 130.174 411.239 131.209 411.054 132.223C414.179 130.792 418.003 129.951 422.134 129.951C431.298 129.951 438.953 134.094 440.812 139.623C441.714 139.553 442.642 139.515 443.588 139.515C452.652 139.515 460.001 142.869 460.001 147.007C460.001 151.144 452.652 154.498 443.588 154.498C441.614 154.498 439.722 154.338 437.969 154.047V154.498H347.605C347.582 154.498 347.559 154.499 347.535 154.499C347.512 154.499 347.488 154.498 347.465 154.498H296.248V154.462C288.836 154.032 282.999 149.362 282.999 143.659C282.999 137.673 289.431 132.82 297.364 132.82C299.191 132.82 300.937 133.08 302.544 133.549C303.161 125.122 310.303 118.475 319.024 118.475C325.13 118.475 330.462 121.733 333.322 126.579C335.76 121.87 339.981 118.482 344.94 117.595C344.808 116.581 344.739 115.546 344.739 114.494C344.739 101.949 354.436 91.7795 366.398 91.7793Z",
	],
	[
		"M449.057 356C470.748 356 489.47 364.837 498.193 377.617C507.447 379.004 515.053 383.492 518.678 389.45C520.044 389.215 521.45 389.093 522.887 389.093C532.824 389.093 541.33 394.964 544.839 403.285C550.915 406.983 554.757 412.43 554.757 418.504C554.757 429.642 541.841 438.672 525.909 438.672C518.937 438.672 512.542 436.942 507.555 434.063C502.568 436.941 496.174 438.671 489.203 438.671C482.23 438.671 475.835 436.941 470.848 434.062C465.861 436.939 459.467 438.669 452.496 438.669C441.912 438.669 432.66 434.683 427.641 428.741C426.186 432.786 420.85 435.786 414.488 435.786C409.095 435.786 404.438 433.63 402.259 430.509C397.002 435.458 388.579 438.667 379.084 438.667C373.746 438.667 368.748 437.652 364.46 435.885C361.743 438.42 357.922 440 353.688 440C345.442 440 338.757 434.01 338.757 426.622C338.757 420.008 344.114 414.516 351.152 413.437C353.715 406.504 361.419 401.018 371.251 399.083C371.18 398.507 371.143 397.925 371.143 397.337C371.143 386.198 384.057 377.168 399.989 377.168C400.07 377.168 400.15 377.169 400.23 377.17C409.082 364.632 427.619 356 449.057 356Z",
		"M441.265 363.335C457.692 363.335 471.536 372.376 475.77 384.708C484.628 387.406 490.954 394.509 490.954 402.847C490.954 405.033 490.518 407.134 489.717 409.092C494.251 409.133 498.531 409.717 502.324 410.723C506.402 405.652 514.083 402.234 522.887 402.234C532.824 402.234 541.329 406.59 544.838 412.762C550.915 415.505 554.757 419.546 554.757 424.052C554.757 432.316 541.841 439.014 525.909 439.014C525 439.014 524.101 438.992 523.213 438.949L354.78 439.97C354.42 439.988 354.056 440 353.688 440C345.442 440 338.757 435.556 338.757 430.075C338.757 425.169 344.113 421.097 351.15 420.296C354.193 414.186 364.49 409.591 376.99 409.126C376.922 408.517 376.885 407.902 376.885 407.281C376.885 395.339 389.801 385.658 405.732 385.658C405.973 385.658 406.214 385.659 406.453 385.664C410.284 372.847 424.416 363.335 441.265 363.335ZM507.555 435.595C507.485 435.625 507.416 435.654 507.346 435.683C507.654 435.753 507.962 435.822 508.268 435.89C508.027 435.794 507.789 435.696 507.555 435.595Z",
	],
] satisfies [string, string][];

const CLOUD_COUNT = CLOUDS_BACK.length + CLOUDS_FRONT.length;

const CLOUD_MIN_Y = 0;
const CLOUD_MAX_Y = 5;

export function Clouds({ style, children, front }: CloudsProps) {
	const progress = useSharedValue(0);
	const { theme } = useUnistyles();

	const cloudProgressRefs = useRef(
		Array.from({ length: CLOUD_COUNT }, () =>
			makeMutable([{ translateY: CLOUD_MIN_Y }] satisfies Transforms3d),
		),
	);

	useEffect(() => {
		progress.value = withRepeat(
			withTiming(1, {
				easing: Easing.inOut(Easing.ease),
				duration: 2250,
			}),
			-1,
			true,
		);
	}, [progress]);

	useAnimatedReaction(
		() => progress.value,
		(cloudProgress) => {
			for (const [index, cloudRef] of cloudProgressRefs.current.entries()) {
				cloudRef.value = [
					{
						translateY: curve(
							cloudProgress + index / cloudProgressRefs.current.length,
							1,
							CLOUD_MAX_Y,
						),
					},
				];
			}
		},
	);

	const baseColor = theme.palette.accent700;
	const stopColors = convertToRGBA(baseColor);
	const colors = [
		baseColor,
		`rgba(${stopColors[0]},${stopColors[1]},${stopColors[2]},0)`,
	];

	return (
		<Canvas style={[styles.container, style]}>
			<Rect
				x={0}
				y={0}
				width={UnistylesRuntime.screen.width}
				height={UnistylesRuntime.screen.height}
			>
				<LinearGradient
					colors={colors}
					start={vec(UnistylesRuntime.screen.width / 2, 0)}
					end={vec(
						UnistylesRuntime.screen.width / 2,
						UnistylesRuntime.screen.height * 0.5,
					)}
					flags={1}
				/>
			</Rect>
			{CLOUDS_BACK.map(([base, highlight], index) => (
				<Group key={index} transform={cloudProgressRefs.current[index]}>
					<Path path={base} color="#FAFDFD" style="fill" />
					<Path path={highlight} color="#E3EFF3" style="fill" />
				</Group>
			))}
			{children}
			{CLOUDS_FRONT.map(([base, highlight], index) => (
				<Group
					key={index}
					transform={cloudProgressRefs.current[index + CLOUDS_BACK.length]}
				>
					<Path path={base} color="#FAFDFD" style="fill" />
					<Path path={highlight} color="#E3EFF3" style="fill" />
				</Group>
			))}
			{front}
		</Canvas>
	);
}

const styles = StyleSheet.create((_, rt) => ({
	container: {
		flex: 1,
		width: rt.screen.width,
		height: rt.screen.height,
		position: "absolute",
		top: 0,
	},
}));
